rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is admin or superadmin
    // Note: This requires the user document to exist and have role field
    function isAdmin() {
      return request.auth != null && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' ||
              get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'superadmin');
    }
    
    // Helper function to check if user is superadmin
    function isSuperAdmin() {
      return request.auth != null && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'superadmin';
    }
    
    // Helper function to check if user owns the bot
    function isBotOwner(botId) {
      return request.auth != null && 
             resource.data.ownerId == request.auth.uid;
    }
    
    // Bots collection rules
    match /bots/{botId} {
      // Allow read if user is admin or owns the bot
      // Note: allowedBotIds check is handled in frontend code
      allow read: if request.auth != null && (
        isAdmin() ||
        isBotOwner(botId) ||
        // Allow read for all authenticated users - frontend will filter by allowedBotIds
        request.auth != null
      );
      
      // Allow create if user is authenticated
      allow create: if request.auth != null && 
                      request.resource.data.ownerId == request.auth.uid;
      
      // Allow update if user is admin or owns the bot
      allow update: if request.auth != null && (
        isAdmin() ||
        isBotOwner(botId)
      );
      
      // Allow delete if user is admin or owns the bot
      allow delete: if request.auth != null && (
        isAdmin() ||
        isBotOwner(botId)
      );
    }
    
    // Users collection rules
    match /users/{userId} {
      // Allow read if user is admin or reading own document
      allow read: if request.auth != null && (
        isAdmin() ||
        userId == request.auth.uid
      );
      
      // Allow create if user is authenticated (for user registration)
      allow create: if request.auth != null && 
                      userId == request.auth.uid;
      
      // Allow update if user is admin or updating own document
      allow update: if request.auth != null && (
        isAdmin() ||
        userId == request.auth.uid
      );
      
      // Allow delete only for admins/superadmins, but superadmins can only be deleted by superadmins
      allow delete: if request.auth != null && (
        isAdmin() &&
        !(resource.data.role == 'superadmin' && !isSuperAdmin())
      );
    }
    
    // Conversations collection rules
    match /conversations/{conversationId} {
      // Allow read if user is admin, or if conversation belongs to user's bot
      allow read: if request.auth != null && (
        isAdmin() ||
        resource.data.botId != null && (
          exists(/databases/$(database)/documents/bots/$(resource.data.botId)) &&
          (
            get(/databases/$(database)/documents/bots/$(resource.data.botId)).data.ownerId == request.auth.uid ||
            (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             resource.data.botId in get(/databases/$(database)/documents/users/$(request.auth.uid)).data.allowedBotIds)
          )
        )
      );
      
      // Allow create if user is authenticated
      allow create: if request.auth != null;
      
      // Allow update if user is admin or conversation belongs to user's bot
      allow update: if request.auth != null && (
        isAdmin() ||
        (resource.data.botId != null &&
         exists(/databases/$(database)/documents/bots/$(resource.data.botId)) &&
         get(/databases/$(database)/documents/bots/$(resource.data.botId)).data.ownerId == request.auth.uid)
      );
      
      // Allow delete if user is admin
      allow delete: if request.auth != null && isAdmin();
    }
    
    // Messages subcollection rules (under conversations)
    match /conversations/{conversationId}/messages/{messageId} {
      // Allow read if user can read the parent conversation
      allow read: if request.auth != null && (
        isAdmin() ||
        exists(/databases/$(database)/documents/conversations/$(conversationId)) &&
        (
          get(/databases/$(database)/documents/conversations/$(conversationId)).data.botId != null &&
          (
            exists(/databases/$(database)/documents/bots/$(get(/databases/$(database)/documents/conversations/$(conversationId)).data.botId)) &&
            (
              get(/databases/$(database)/documents/bots/$(get(/databases/$(database)/documents/conversations/$(conversationId)).data.botId)).data.ownerId == request.auth.uid ||
              (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
               get(/databases/$(database)/documents/conversations/$(conversationId)).data.botId in get(/databases/$(database)/documents/users/$(request.auth.uid)).data.allowedBotIds)
            )
          )
        )
      );
      
      // Allow create if user is authenticated
      allow create: if request.auth != null;
      
      // Allow update if user is admin
      allow update: if request.auth != null && isAdmin();
      
      // Allow delete if user is admin
      allow delete: if request.auth != null && isAdmin();
    }
  }
}
