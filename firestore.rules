rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is admin or superadmin
    // Note: This requires the user document to exist and have role field
    function isAdmin() {
      return request.auth != null && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' ||
              get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'superadmin');
    }
    
    // Helper function to check if user is superadmin
    function isSuperAdmin() {
      return request.auth != null && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'superadmin';
    }
    
    // Helper function to check if user owns the bot
    function isBotOwner(botId) {
      return request.auth != null && 
             resource.data.ownerId == request.auth.uid;
    }
    
    // Helper function to check if user has access to bot via allowedBotIds
    function hasBotAccess(botId) {
      return request.auth != null &&
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.allowedBotIds != null &&
             botId in get(/databases/$(database)/documents/users/$(request.auth.uid)).data.allowedBotIds;
    }
    
    // Bots collection rules
    match /bots/{botId} {
      // Allow read for everyone (public data for widgets)
      // Admin/owner checks are still enforced for write operations
      allow read: if true;
      
      // Allow create if user is authenticated
      allow create: if request.auth != null && 
                      request.resource.data.ownerId == request.auth.uid;
      
      // Allow update if user is admin, owns the bot, or has access via allowedBotIds
      allow update: if request.auth != null && (
        isAdmin() ||
        isBotOwner(botId) ||
        hasBotAccess(botId)
      );
      
      // Allow delete if user is admin or owns the bot
      allow delete: if request.auth != null && (
        isAdmin() ||
        isBotOwner(botId)
      );
    }
    
    // Users collection rules
    match /users/{userId} {
      // Allow read if user is admin or reading own document
      allow read: if request.auth != null && (
        isAdmin() ||
        userId == request.auth.uid
      );
      
      // Allow create if user is authenticated (for user registration)
      allow create: if request.auth != null && 
                      userId == request.auth.uid;
      
      // Allow update if user is admin or updating own document
      allow update: if request.auth != null && (
        isAdmin() ||
        userId == request.auth.uid
      );
      
      // Allow delete only for admins/superadmins, but superadmins can only be deleted by superadmins
      allow delete: if request.auth != null && (
        isAdmin() &&
        !(resource.data.role == 'superadmin' && !isSuperAdmin())
      );
    }
    
    // Conversations collection rules
    match /conversations/{conversationId} {
      // Allow read for everyone (widgets need to read their own conversations)
      // Admin checks are still enforced for write operations
      allow read: if true;
      
      // Allow create for everyone (widgets need to create conversations)
      // But validate that botId exists and data structure is correct
      allow create: if request.resource.data.botId != null &&
                     request.resource.data.visitorId != null &&
                     request.resource.data.visitorId is string &&
                     request.resource.data.botId is string &&
                     request.resource.data.visitorId.size() > 0 &&
                     request.resource.data.botId.size() > 0 &&
                     exists(/databases/$(database)/documents/bots/$(request.resource.data.botId)) &&
                     (!('ownerId' in request.resource.data) || request.resource.data.ownerId == null) &&
                     (!('agentId' in request.resource.data) || request.resource.data.agentId == null) &&
                     request.resource.data.isEnded == false &&
                     request.resource.data.status is string;
      
      // Allow update if:
      // 1. User is admin, OR
      // 2. User owns the bot, OR
      // 3. User has access via allowedBotIds, OR
      // 4. Updating visitor's own conversation (visitorId matches and not changing critical fields)
      allow update: if (
        // Admin can update anything
        (request.auth != null && isAdmin()) ||
        // Bot owner can update
        (request.auth != null && resource.data.botId != null &&
         exists(/databases/$(database)/documents/bots/$(resource.data.botId)) &&
         get(/databases/$(database)/documents/bots/$(resource.data.botId)).data.ownerId == request.auth.uid) ||
        // User with bot access can update
        (request.auth != null && resource.data.botId != null &&
         exists(/databases/$(database)/documents/bots/$(resource.data.botId)) &&
         exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
         resource.data.botId in get(/databases/$(database)/documents/users/$(request.auth.uid)).data.allowedBotIds) ||
        // Visitor can update their own conversation (for adding messages)
        // Ensure visitorId matches and we're only updating messages/visitorName (not botId or other critical fields)
        (resource.data.visitorId != null && 
         request.resource.data.visitorId == resource.data.visitorId &&
         request.resource.data.botId == resource.data.botId &&
         // Prevent changing critical fields
         (!('ownerId' in request.resource.data) || request.resource.data.ownerId == null) &&
         (!('agentId' in request.resource.data) || request.resource.data.agentId == resource.data.agentId))
      );
      
      // Allow delete only for admins
      allow delete: if request.auth != null && isAdmin();
    }
    
    // Messages subcollection rules (under conversations)
    match /conversations/{conversationId}/messages/{messageId} {
      // Allow read if user can read the parent conversation
      allow read: if request.auth != null && (
        isAdmin() ||
        exists(/databases/$(database)/documents/conversations/$(conversationId)) &&
        (
          get(/databases/$(database)/documents/conversations/$(conversationId)).data.botId != null &&
          (
            exists(/databases/$(database)/documents/bots/$(get(/databases/$(database)/documents/conversations/$(conversationId)).data.botId)) &&
            (
              get(/databases/$(database)/documents/bots/$(get(/databases/$(database)/documents/conversations/$(conversationId)).data.botId)).data.ownerId == request.auth.uid ||
              (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
               get(/databases/$(database)/documents/conversations/$(conversationId)).data.botId in get(/databases/$(database)/documents/users/$(request.auth.uid)).data.allowedBotIds)
            )
          )
        )
      );
      
      // Allow create if user is authenticated
      allow create: if request.auth != null;
      
      // Allow update if user is admin or has access to the bot via allowedBotIds
      allow update: if request.auth != null && (
        isAdmin() ||
        (exists(/databases/$(database)/documents/conversations/$(conversationId)) &&
         get(/databases/$(database)/documents/conversations/$(conversationId)).data.botId != null &&
         (
           exists(/databases/$(database)/documents/bots/$(get(/databases/$(database)/documents/conversations/$(conversationId)).data.botId)) &&
           (
             get(/databases/$(database)/documents/bots/$(get(/databases/$(database)/documents/conversations/$(conversationId)).data.botId)).data.ownerId == request.auth.uid ||
             (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
              get(/databases/$(database)/documents/conversations/$(conversationId)).data.botId in get(/databases/$(database)/documents/users/$(request.auth.uid)).data.allowedBotIds)
           )
         )
        )
      );
      
      // Allow delete if user is admin or has access to the bot via allowedBotIds
      allow delete: if request.auth != null && (
        isAdmin() ||
        (exists(/databases/$(database)/documents/conversations/$(conversationId)) &&
         get(/databases/$(database)/documents/conversations/$(conversationId)).data.botId != null &&
         (
           exists(/databases/$(database)/documents/bots/$(get(/databases/$(database)/documents/conversations/$(conversationId)).data.botId)) &&
           (
             get(/databases/$(database)/documents/bots/$(get(/databases/$(database)/documents/conversations/$(conversationId)).data.botId)).data.ownerId == request.auth.uid ||
             (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
              get(/databases/$(database)/documents/conversations/$(conversationId)).data.botId in get(/databases/$(database)/documents/users/$(request.auth.uid)).data.allowedBotIds)
           )
         )
        )
      );
    }
  }
}
